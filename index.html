<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マルチタイマー</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🕐</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">⚙️ 設定</h2>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">🏠 部屋ID</h3>
                <input type="text" id="roomIdInput" placeholder="room-123" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg mb-2">
                <button onclick="changeRoom()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold mb-2">部屋を変更</button>
                <p class="text-xs text-gray-500">現在: <span id="currentRoomDisplay" class="font-bold">ローカル</span></p>
            </div>

            <hr class="my-6">

            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">🔔 アラーム設定</h3>
                
                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm">アラーム音</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="alarmToggle" checked onchange="toggleAlarm(this.checked)" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                    </label>
                </div>

                <div class="mb-4">
                    <label class="block text-sm mb-2">音量: <span id="volumeDisplay">50</span>%</label>
                    <input type="range" id="volumeSlider" min="0" max="100" value="50" oninput="updateVolume(this.value)" class="w-full">
                </div>

                <div class="mb-4">
                    <label class="block text-sm mb-2">アラーム音の種類</label>
                    <select id="soundSelect" onchange="changeSound(this.value)" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                        <option value="beep">ビープ音</option>
                        <option value="bell">ベル</option>
                        <option value="alarm">アラーム</option>
                        <option value="custom">カスタム音</option>
                    </select>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm">バイブレーション</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="vibrationToggle" checked onchange="toggleVibration(this.checked)" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-indigo-600 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                    </label>
                </div>

                <div id="customSoundDiv" class="hidden mb-4">
                    <label class="block text-sm mb-2">音声ファイルURL</label>
                    <input type="text" id="customSoundInput" placeholder="https://example.com/sound.mp3" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg mb-2">
                    <button onclick="saveCustomSound()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">保存</button>
                </div>

                <button onclick="testAlarm()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold">🔊 テスト再生</button>
            </div>

            <hr class="my-6">

            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-3">🔄 リセット</h3>
                <button onclick="resetAllTimers()" class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold mb-2">すべてのタイマーをリセット</button>
                <p class="text-xs text-gray-500">※タイマーを#1から作り直します</p>
            </div>

            <hr class="my-6">

            <div>
                <h3 class="text-lg font-semibold text-gray-700 mb-3">📝 ログ</h3>
                <button onclick="showLogs()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold">ログを表示</button>
            </div>
        </div>
    </div>

    <div id="logsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">📝 ログ</h2>
                <button onclick="closeLogs()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="logsContainer" class="space-y-3"></div>
            <button onclick="clearAllLogs()" class="mt-6 w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">すべてのログを削除</button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">🕐 マルチタイマー</h1>
                <p class="text-gray-600">複数人でリアルタイムに共有できます</p>
            </div>
            <button onclick="openSettings()" class="bg-white hover:bg-gray-100 text-gray-700 p-3 rounded-lg shadow-lg text-2xl">⚙️</button>
        </div>

        <div class="text-center mb-6">
            <div class="bg-white rounded-lg shadow p-3 inline-block">
                <p class="text-sm text-gray-600">
                    <span id="connectionStatus" class="font-semibold">💾 ローカル</span>
                    <span class="mx-2">|</span>
                    部屋: <span id="currentRoom" class="font-bold text-indigo-600">ローカル</span>
                </p>
            </div>
        </div>

        <div id="timersContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

        <div class="text-center">
            <button onclick="addMoreTimers()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg">＜さらに表示させる＞</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bjvczgambygfqlnfpdsg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqdmN6Z2FtYnlnZnFsbmZwZHNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDEwMzcsImV4cCI6MjA3NjE3NzAzN30.lzZAJK669hs-4E1TZnC2DcwIcn4vEL6grcDwdmiF_d0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentRoom = localStorage.getItem('currentRoom') || null;
        let timers = [];
        let intervals = {};
        let logs = JSON.parse(localStorage.getItem('timerLogs') || '[]');
        
        let alarmEnabled = localStorage.getItem('alarmEnabled') !== 'false';
        let alarmVolume = parseFloat(localStorage.getItem('alarmVolume') || '0.5');
        let alarmSound = localStorage.getItem('alarmSound') || 'beep';
        let customAlarmUrl = localStorage.getItem('customAlarmUrl') || '';
        let vibrationEnabled = localStorage.getItem('vibrationEnabled') !== 'false';

        let audioContext = null;
        let alarmIntervals = {};

        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        function playBeep() {
            const ctx = getAudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 800;
            gain.gain.value = alarmVolume;
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.stop(ctx.currentTime + 0.5);
        }

        function playBell() {
            const ctx = getAudioContext();
            const frequencies = [523, 659, 784];
            frequencies.forEach((freq, i) => {
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    gain.gain.value = alarmVolume;
                    osc.start();
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    osc.stop(ctx.currentTime + 0.3);
                }, i * 150);
            });
        }

        function playAlarm() {
            const ctx = getAudioContext();
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = i % 2 === 0 ? 880 : 1046;
                    gain.gain.value = alarmVolume;
                    osc.start();
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    osc.stop(ctx.currentTime + 0.3);
                }, i * 400);
            }
        }

        window.onload = function() {
            document.getElementById('alarmToggle').checked = alarmEnabled;
            document.getElementById('volumeSlider').value = alarmVolume * 100;
            document.getElementById('volumeDisplay').textContent = Math.round(alarmVolume * 100);
            document.getElementById('soundSelect').value = alarmSound;
            document.getElementById('vibrationToggle').checked = vibrationEnabled;
            if (alarmSound === 'custom') {
                document.getElementById('customSoundDiv').classList.remove('hidden');
                document.getElementById('customSoundInput').value = customAlarmUrl;
            }
            
            // 通知の許可をリクエスト
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            initializeTimers();
            if (currentRoom) {
                document.getElementById('currentRoom').textContent = currentRoom;
                document.getElementById('currentRoomDisplay').textContent = currentRoom;
                loadTimers();
                subscribeToChanges();
            }
        };

        function initializeTimers() {
            if (!currentRoom) {
                const savedTimers = localStorage.getItem('localTimers');
                if (savedTimers) {
                    timers = JSON.parse(savedTimers);
                    renderTimers();
                    startAllIntervals();
                    return;
                }
            }
            timers = [];
            for (let i = 1; i <= 4; i++) {
                timers.push({id: i, hours: 0, minutes: 0, seconds: 0, totalSeconds: 0, isRunning: false, remainingSeconds: 0, memo: '', isSnoozing: false});
            }
            renderTimers();
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('roomIdInput').value = currentRoom || '';
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function toggleAlarm(enabled) {
            alarmEnabled = enabled;
            localStorage.setItem('alarmEnabled', enabled);
        }

        function toggleVibration(enabled) {
            vibrationEnabled = enabled;
            localStorage.setItem('vibrationEnabled', enabled);
        }

        function updateVolume(value) {
            alarmVolume = value / 100;
            localStorage.setItem('alarmVolume', alarmVolume);
            document.getElementById('volumeDisplay').textContent = value;
        }

        function changeSound(value) {
            alarmSound = value;
            localStorage.setItem('alarmSound', value);
            if (value === 'custom') {
                document.getElementById('customSoundDiv').classList.remove('hidden');
            } else {
                document.getElementById('customSoundDiv').classList.add('hidden');
            }
        }

        function saveCustomSound() {
            customAlarmUrl = document.getElementById('customSoundInput').value;
            localStorage.setItem('customAlarmUrl', customAlarmUrl);
            alert('カスタム音を保存しました');
        }

        function testAlarm() {
            playSound();
        }

        function playSound() {
            if (!alarmEnabled && !vibrationEnabled) return;
            
            if (vibrationEnabled && 'vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
            
            if (alarmEnabled) {
                if (alarmSound === 'custom' && customAlarmUrl) {
                    const audio = new Audio(customAlarmUrl);
                    audio.volume = alarmVolume;
                    audio.play().catch(() => alert('音声の再生に失敗しました'));
                } else if (alarmSound === 'beep') {
                    playBeep();
                } else if (alarmSound === 'bell') {
                    playBell();
                } else if (alarmSound === 'alarm') {
                    playAlarm();
                }
            }
        }

        function startAlarmLoop(timerId) {
            stopAlarmLoop(timerId);
            
            // バイブレーション（Androidのみ対応）
            if (vibrationEnabled && 'vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
                alarmIntervals[`vib-${timerId}`] = setInterval(() => {
                    navigator.vibrate([200, 100, 200, 100, 200]);
                }, 1500);
            }
            
            // 音声アラーム
            if (alarmEnabled) {
                let audioElement = null;
                
                const playAlarmSound = () => {
                    try {
                        if (alarmSound === 'custom' && customAlarmUrl) {
                            if (!audioElement) {
                                audioElement = new Audio(customAlarmUrl);
                                audioElement.volume = alarmVolume;
                                audioElement.loop = false;
                            }
                            audioElement.currentTime = 0;
                            audioElement.play().catch(err => console.log('Audio play failed:', err));
                        } else if (alarmSound === 'beep') {
                            playBeep();
                        } else if (alarmSound === 'bell') {
                            playBell();
                        } else if (alarmSound === 'alarm') {
                            playAlarm();
                        }
                    } catch (e) {
                        console.log('Sound error:', e);
                    }
                };
                
                playAlarmSound();
                alarmIntervals[`sound-${timerId}`] = setInterval(playAlarmSound, 2000);
            }
            
            // iOSの通知（フォールバック）
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('⏰ タイマー完了！', {
                    body: `タイマー #${timerId} が終了しました`,
                    tag: `timer-${timerId}`,
                    requireInteraction: true
                });
            }
        }

        function stopAlarmLoop(timerId) {
            if (alarmIntervals[`vib-${timerId}`]) {
                clearInterval(alarmIntervals[`vib-${timerId}`]);
                delete alarmIntervals[`vib-${timerId}`];
                if ('vibrate' in navigator) {
                    navigator.vibrate(0);
                }
            }
            if (alarmIntervals[`sound-${timerId}`]) {
                clearInterval(alarmIntervals[`sound-${timerId}`]);
                delete alarmIntervals[`sound-${timerId}`];
            }
        }

        function changeRoom() {
            const newRoom = document.getElementById('roomIdInput').value.trim();
            if (!newRoom) {
                alert('部屋IDを入力してください');
                return;
            }
            currentRoom = newRoom;
            localStorage.setItem('currentRoom', currentRoom);
            document.getElementById('currentRoom').textContent = currentRoom;
            document.getElementById('currentRoomDisplay').textContent = currentRoom;
            closeSettings();
            loadTimers();
            subscribeToChanges();
        }

        function resetAllTimers() {
            if (confirm('すべてのタイマーを#1から作り直しますか？')) {
                Object.keys(alarmIntervals).forEach(key => {
                    if (key.startsWith('vib-')) {
                        clearInterval(alarmIntervals[key]);
                        if ('vibrate' in navigator) {
                            navigator.vibrate(0);
                        }
                    } else if (key.startsWith('sound-')) {
                        clearInterval(alarmIntervals[key]);
                    }
                });
                alarmIntervals = {};
                timers = [];
                for (let i = 1; i <= 4; i++) {
                    timers.push({id: i, hours: 0, minutes: 0, seconds: 0, totalSeconds: 0, isRunning: false, remainingSeconds: 0, memo: '', isSnoozing: false});
                }
                saveTimers();
                alert('タイマーを#1からリセットしました！');
            }
        }

        function showLogs() {
            closeSettings();
            document.getElementById('logsModal').classList.remove('hidden');
            renderLogs();
        }

        function closeLogs() {
            document.getElementById('logsModal').classList.add('hidden');
        }

        function renderLogs() {
            const container = document.getElementById('logsContainer');
            if (logs.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">ログがありません</p>';
                return;
            }
            container.innerHTML = logs.map(log => `
                <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <span class="text-xl font-bold text-indigo-600">${formatTime(log.totalSeconds)}</span>
                            ${log.memo ? `<span class="text-gray-700 font-medium">${log.memo}</span>` : ''}
                        </div>
                        <div class="text-sm text-gray-500 mt-1">完了: ${log.completedAt}</div>
                    </div>
                    <button onclick="deleteLog(${log.id})" class="text-red-500 hover:text-red-700">🗑️</button>
                </div>
            `).join('');
        }

        function deleteLog(logId) {
            logs = logs.filter(log => log.id !== logId);
            localStorage.setItem('timerLogs', JSON.stringify(logs));
            renderLogs();
        }

        function clearAllLogs() {
            if (confirm('すべてのログを削除しますか?')) {
                logs = [];
                localStorage.setItem('timerLogs', JSON.stringify(logs));
                renderLogs();
            }
        }

        function addLog(timer) {
            const logEntry = {id: Date.now(), timerId: timer.id, memo: timer.memo, totalSeconds: timer.totalSeconds, completedAt: new Date().toLocaleString('ja-JP')};
            logs.unshift(logEntry);
            localStorage.setItem('timerLogs', JSON.stringify(logs));
        }

        async function loadTimers() {
            if (!currentRoom) return;
            const { data, error } = await supabase.from('timers').select('*').eq('room_id', currentRoom).single();
            if (error && error.code === 'PGRST116') {
                renderTimers();
                await saveTimers();
            } else if (data) {
                timers = data.timer_data || [];
                if (timers.length === 0) {
                    initializeTimers();
                    await saveTimers();
                }
                renderTimers();
            }
            startAllIntervals();
        }

        async function saveTimers() {
            if (!currentRoom) {
                localStorage.setItem('localTimers', JSON.stringify(timers));
                renderTimers();
                return;
            }
            const { data, error } = await supabase.from('timers').upsert({room_id: currentRoom, timer_data: timers, updated_at: new Date().toISOString()}, { onConflict: 'room_id' });
            if (error) console.error('保存エラー:', error);
        }

        function subscribeToChanges() {
            if (!currentRoom) return;
            supabase.channel('timer-changes').on('postgres_changes', { event: '*', schema: 'public', table: 'timers', filter: `room_id=eq.${currentRoom}` }, (payload) => {
                if (payload.new && payload.new.timer_data) {
                    timers = payload.new.timer_data;
                    renderTimers();
                    startAllIntervals();
                }
            }).subscribe((status) => {
                document.getElementById('connectionStatus').textContent = status === 'SUBSCRIBED' ? '🟢 接続中' : '🔴 切断';
            });
        }

        function renderTimers() {
            const container = document.getElementById('timersContainer');
            container.innerHTML = '';
            timers.forEach(timer => {
                const timerCard = createTimerCard(timer);
                container.appendChild(timerCard);
            });
        }

        function createTimerCard(timer) {
            const card = document.createElement('div');
            const isSetup = timer.remainingSeconds === 0 && !timer.isRunning && timer.totalSeconds === 0;
            const isFinished = timer.remainingSeconds === 0 && timer.totalSeconds > 0;
            let ringClass = '';
            if (isFinished) ringClass = 'ring-4 ring-green-500 animate-pulse';
            else if (timer.isSnoozing) ringClass = 'ring-4 ring-red-500 animate-pulse';
            card.className = `bg-white rounded-xl shadow-lg p-6 relative ${ringClass}`;
            card.innerHTML = `
                <button onclick="clearTimer(${timer.id})" class="absolute top-3 right-3 text-red-500 hover:text-red-700">🗑️</button>
                <div class="flex items-center justify-between mb-4 pr-8">
                    <h3 class="text-lg font-semibold text-gray-700 flex items-center gap-2">🕐 #${timer.id}</h3>
                    <input type="text" value="${timer.memo}" onchange="updateMemo(${timer.id}, this.value)" placeholder="メモ..." class="px-3 py-1 border border-gray-300 rounded-lg text-sm flex-1 mx-4">
                </div>
                ${isSetup ? `
                    <div class="flex gap-4 mb-4">
                        <div class="flex-1"><label class="block text-sm text-gray-600 mb-1">時</label><input type="number" value="${timer.hours}" onchange="updateTime(${timer.id}, 'hours', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-center text-lg"></div>
                        <div class="flex-1"><label class="block text-sm text-gray-600 mb-1">分</label><input type="number" value="${timer.minutes}" onchange="updateTime(${timer.id}, 'minutes', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-center text-lg"></div>
                        <div class="flex-1"><label class="block text-sm text-gray-600 mb-1">秒</label><input type="number" value="${timer.seconds}" onchange="updateTime(${timer.id}, 'seconds', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-center text-lg"></div>
                    </div>
                    <div class="grid grid-cols-4 gap-2 mb-2">${[60, 30, 10, 5].map(m => `<button onclick="adjustMinutes(${timer.id}, ${m})" class="bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 px-3 py-2 rounded text-sm font-semibold">+${m}</button>`).join('')}</div>
                    <div class="grid grid-cols-4 gap-2 mb-4">${[60, 30, 10, 5].map(m => `<button onclick="adjustMinutes(${timer.id}, -${m})" class="bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 px-3 py-2 rounded text-sm font-semibold">-${m}</button>`).join('')}</div>
                    <button onclick="startTimer(${timer.id})" class="w-full bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold">▶ スタート</button>
                ` : `
                    <div class="text-center mb-4"><div class="text-5xl font-bold ${isFinished ? 'text-green-600' : 'text-gray-800'}">${formatTime(timer.remainingSeconds)}</div>${isFinished ? '<div class="text-green-600 font-semibold mt-2">完了!</div>' : ''}</div>
                    ${!isFinished ? `<div class="grid grid-cols-4 gap-2 mb-2">${[60, 30, 10, 5].map(m => `<button onclick="adjustRunningTime(${timer.id}, ${m})" class="bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 px-3 py-2 rounded text-sm font-semibold">+${m}</button>`).join('')}</div><div class="grid grid-cols-4 gap-2 mb-4">${[60, 30, 10, 5].map(m => `<button onclick="adjustRunningTime(${timer.id}, -${m})" class="bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 px-3 py-2 rounded text-sm font-semibold">-${m}</button>`).join('')}</div>` : ''}
                    <div class="flex gap-2">${isFinished ? `<button onclick="stopTimer(${timer.id})" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">⏹ 停止</button><select onchange="snooze(${timer.id}, this.value); this.value='';" class="flex-1 bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold"><option value="">スヌーズ</option><option value="1">1分</option><option value="3">3分</option><option value="5">5分</option><option value="7">7分</option><option value="10">10分</option></select>` : `${timer.isRunning ? `<button onclick="pauseTimer(${timer.id})" class="flex-1 bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold">⏸ 一時停止</button>` : `<button onclick="resumeTimer(${timer.id})" class="flex-1 bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold">▶ 再開</button>`}<button onclick="resetTimer(${timer.id})" class="flex-1 bg-white hover:bg-gray-100 border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold">🔄 リセット</button>`}</div>
                `}
            `;
            return card;
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        function updateMemo(id, memo) { const timer = timers.find(t => t.id === id); if (timer) { timer.memo = memo; saveTimers(); } }
        function updateTime(id, field, value) { const timer = timers.find(t => t.id === id); if (timer) { timer[field] = parseInt(value) || 0; saveTimers(); } }
        function adjustMinutes(id, amount) { const timer = timers.find(t => t.id === id); if (timer) { const totalMinutes = timer.hours * 60 + timer.minutes + amount; if (totalMinutes >= 0) { timer.hours = Math.floor(totalMinutes / 60); timer.minutes = totalMinutes % 60; saveTimers(); } } }
        function adjustRunningTime(id, amount) { const timer = timers.find(t => t.id === id); if (timer) { const newRemaining = timer.remainingSeconds + (amount * 60); if (newRemaining >= 0) { timer.remainingSeconds = newRemaining; timer.totalSeconds = newRemaining; saveTimers(); } } }
        function startTimer(id) { const timer = timers.find(t => t.id === id); if (timer) { const total = timer.hours * 3600 + timer.minutes * 60 + timer.seconds; if (total > 0) { timer.totalSeconds = total; timer.remainingSeconds = total; timer.isRunning = true; timer.isSnoozing = false; saveTimers(); } } }
        function pauseTimer(id) { const timer = timers.find(t => t.id === id); if (timer) { timer.isRunning = false; saveTimers(); } }
        function resumeTimer(id) { const timer = timers.find(t => t.id === id); if (timer) { timer.isRunning = true; saveTimers(); } }
        function resetTimer(id) { const timer = timers.find(t => t.id === id); if (timer) { stopAlarmLoop(id); timer.isRunning = false; timer.remainingSeconds = 0; timer.totalSeconds = 0; timer.isSnoozing = false; saveTimers(); } }
        function stopTimer(id) { resetTimer(id); }
        function snooze(id, minutes) { 
            const timer = timers.find(t => t.id === id); 
            if (timer && minutes) { 
                stopAlarmLoop(id);
                const snoozeSeconds = parseInt(minutes) * 60; 
                timer.totalSeconds = snoozeSeconds; 
                timer.remainingSeconds = snoozeSeconds; 
                timer.isRunning = true; 
                timer.isSnoozing = true; 
                saveTimers(); 
            } 
        }
        function clearTimer(id) { 
            const timer = timers.find(t => t.id === id); 
            if (timer) { 
                stopAlarmLoop(id);
                timer.hours = 0;
                timer.minutes = 0;
                timer.seconds = 0;
                timer.isRunning = false; 
                timer.remainingSeconds = 0; 
                timer.totalSeconds = 0; 
                timer.isSnoozing = false;
                timer.memo = '';
                saveTimers(); 
            } 
        }
        function addMoreTimers() { 
            const maxId = Math.max(...timers.map(t => t.id), 0); 
            for (let i = 1; i <= 4; i++) { 
                timers.push({id: maxId + i, hours: 0, minutes: 0, seconds: 0, totalSeconds: 0, isRunning: false, remainingSeconds: 0, memo: '', isSnoozing: false}); 
            } 
            saveTimers(); 
        }
        
        function startAllIntervals() {
            Object.values(intervals).forEach(interval => clearInterval(interval));
            intervals = {};
            timers.forEach(timer => {
                if (timer.isRunning && timer.remainingSeconds > 0) {
                    intervals[timer.id] = setInterval(() => {
                        const t = timers.find(x => x.id === timer.id);
                        if (t && t.isRunning && t.remainingSeconds > 0) {
                            t.remainingSeconds--;
                            if (t.remainingSeconds === 0) {
                                t.isRunning = false;
                                startAlarmLoop(t.id);
                                addLog(t);
                            }
                            renderTimers();
                            if (t.remainingSeconds === 0) saveTimers();
                        }
                    }, 1000);
                }
            });
        }
    </script>
</body>
</html>